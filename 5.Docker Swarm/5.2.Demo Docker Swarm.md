# Demo Docker Swarm

Docker Swarm **cluster**ni yaratish va boshqarish bo‘yicha ushbu batafsil qo‘llanmaga xush kelibsiz. Ushbu **tutorial**da siz **Docker Swarm cluster**ni qanday **initialize** qilishni, **worker** va **manager node**larni qo‘shishni, **node failure**larni **simulate** qilishni va **manager failure**lardan tiklanishni o‘rganasiz — bularning barchasi sog‘lom **quorum**ni saqlagan holda amalga oshiriladi. Ushbu qo‘llanma **DevOps engineer**lar va **system administrator**lar uchun bardoshli **container orchestration**ni **Docker Swarm** yordamida joriy etishda muhim manba bo‘lib xizmat qiladi.

## Setting Up the Swarm Cluster

Ushbu **demo**da uchta **server** ishlatiladi. Ulardan biri **Docker master** sifatida, qolgan ikkitasi esa **Docker node**lar sifatida xizmat qiladi. Dastlab, har bir **server**da faqat **Docker** o‘rnatilgan bo‘ladi, ular orasidagi yagona farq — ularning **hostname**laridir.

**Swarm cluster**ni yaratish uchun, uchta **server** orasidan **Docker master**ni aniqlang va **swarm**ni **initialize** qiling. Agar quyidagi buyruqni **advertised address**siz ishga tushirsangiz, **Docker host**da bir nechta **network interface** mavjudligi sababli xato yuz beradi:

```bash
root@DOCKER_MASTER:/root # docker swarm init
Error response from daemon: could not choose an IP address to advertise since this system has multiple addresses on different interfaces (192.168.1.9 on eth0 and 192.168.56.101 on eth1) - specify one with --advertise-addr
```

Master da ikkita tarmoq interfeysi (network interfaces) mavjud bo‘lganligi sababli, IP manzilni `--advertise-addr` flag yordamida belgilang. Ushbu misolda biz `192.168.56.101` IP manzilini e’lon qilishni tanlaymiz:

```bash
root@DOCKER_MASTER:/root # docker swarm init --advertise-addr 192.168.56.101
Swarm initialized: current node (uiddwelph55pjtk6vi97tsn5s) is now a manager.


To add a worker to this swarm, run the following command:
    docker swarm join --token SWMTKN-1-5hp18wx356c33n90tlyv40b4a68g9gylqbb3iz2xnk0fneu1-5a6525x9twuwpdg8v46jj29ul 192.168.56.101:2377


To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
root@DOCKER_MASTER:/root #
```

Natijada swarm’ga yangi node qo‘shish uchun zarur bo‘lgan command taqdim etiladi. Yaratilgan token worker node’ning cluster’ga qo‘shilishi uchun authentication sifatida xizmat qiladi.

Master’da `docker node ls` command bajarilganda, hozircha faqat master node ko‘rinadi (active va leader sifatida belgilangan), chunki hali qo‘shimcha node’lar qo‘shilmagan.

Worker node’larni qo‘shish uchun quyidagi bosqichlarni bajaring:

1. Yaratilgan `docker swarm join` command’ni nusxalang.  
2. Uni har bir worker server’da bajaring.  

Masalan, worker node’da `join` command bajarilganda quyidagi tasdiqlovchi xabar chiqadi:

```bash
root@Docker_NODE1:/root # docker swarm join --token SWMTKN-1-5hp18wx356c33n90tlyv40b4a68g9gylqbb3iz2xnk0fneui4-5a6525x9tvwwpdg 
This node joined a swarm as a worker.
```

Worker node muvaffaqiyatli qo‘shilgandan so‘ng, master node ro‘yxatida ikkala node — master (yulduzcha bilan belgilangan va **Leader** deb nomlangan) hamda yangi worker — ko‘rsatiladi:

```bash
root@DOCKER_MASTER:/root # docker node ls
ID                            HOSTNAME        STATUS  AVAILABILITY  MANAGER STATUS
uildwelph5spjtk6vi97tsn5s *   docker-master   Ready   Active        Leader
lzd18400ditete34e5nvsdn4n     docker-node1    Ready   Active
```

Xuddi shu jarayonni ikkinchi worker node’da ham takrorlang. Ikkala node ulanib bo‘lgach, `docker node ls` jami uchta node’ni ko‘rsatadi: bitta master va ikkita worker.

Agar sizga node’ni o‘chirish kerak bo‘lsa, swarm’dan chiqmoqchi bo‘lgan node’da quyidagi buyruqni bajaring:

```bash
root@DOCKER_NODE2:/root # docker swarm leave
Node left the swarm.
```

>Shuni yodda tutingki, node holati “Ready” dan “Down” ga o‘zgarishi uchun biroz kechikish bo‘lishi mumkin. Ro‘yxatda qolayotgan node’ni butunlay o‘chirish uchun master node’dan quyidagi buyruqni bajaring:

```bash
root@DOCKER_MASTER:/root # docker node rm docker-node1
```

## Manager Node’larni qo‘shish  

Docker Swarm cluster bir nechta manager node’larni qo‘llab-quvvatlashi mumkin, bu esa yuqori darajadagi mavjudlikni (high availability) sezilarli darajada oshiradi. Yangi manager qo‘shish uchun:

Agar kerak bo‘lsa, node’ning hostname’sini o‘zgartiring.  
Quyidagi buyruqni bajarish orqali manager join token’ni oling:

```bash
root@docker-master:/root # docker swarm join-token manager
To add a manager to this swarm, run the following command:


    docker swarm join --token SWMTKN-1-5hp18wx356c33n90tly40b4a68g9gy1qbb3iz2xnk0fneu4-7jbbj8kldn4jaj2naidz9lh7 192.168.56.101:2377
```

Keyingi bosqichda, berilgan buyruqni mo‘ljallangan manager node’da (masalan, docker-master2) bajaring:

```bash
root@docker-master2:/root # docker swarm join --token SWMTKN-1-5hp18wx356c33n90tlyv40b4a68g9gylqbb3i2zxnk0fneu4-7jbbjj8kldn4jaj2naidz9lh7 192.168.56.101:2377
This node joined a swarm as a manager.
```

Qo‘shilganidan so‘ng, docker node ls buyrug‘ini bajarganda ikkita manager ko‘rinadi: biri Leader sifatida, ikkinchisi esa Reachable sifatida belgilanadi. Worker node’larda esa manager statusi ko‘rsatilmaydi.

Qo‘shimcha worker node qo‘shish uchun, quyidagi buyruq yordamida worker join token ni oling:

```bash
root@docker-master:/root # docker swarm join-token worker
```

Keyin, worker mashinada join buyrug‘ini bajaring.

Ba’zan mavjud worker node’ni manager sifatida ko‘tarish kerak bo‘lishi mumkin. Buning uchun faol manager node’dan quyidagi promotion buyrug‘ini bajaring:

```bash
root@docker-master:/root # docker node promote docker-node2
```

Keyingi safar docker node ls buyrug‘ini bajarganda, docker-node2 endi manager holatida ekanligini ko‘rasiz — odatda “Reachable” yoki “Leader” sifatida — qolgan worker node’lar esa hali ham bo‘sh manager status’ini ko‘rsatadi.

Docker Swarm cluster’ni boshqarishda muhim jihatlardan biri bu node nosozliklarini boshqarishdir. Manager node nosozligini simulyatsiya qilish uchun, manager node’lardan birini o‘chirib qo‘ying. Masalan, docker-master3’ni o‘chirib qo‘yish natijasida uning holati quyidagicha “Unreachable” ga o‘zgaradi:

```bash
root@docker-master:/root # docker node ls
ID                            HOSTNAME          STATUS      AVAILABILITY  MANAGER STATUS
qp9p5cmbhf3czl3rxy342pywc     docker-master3    Ready       Active        Unreachable
uildwelph5spjtk6vi97tsn5      docker-master     Ready       Active        Leader
zycf5u8yudke6nfzo74gryssx     docker-master2    Ready       Active        Reachable
```

>Uchta manager’li Docker Swarm cluster’da quorum’ni saqlab qolish uchun ko‘pchilik (kamida ikkitasi) faol bo‘lishi kerak. Agar juda ko‘p manager’lar oflayn holatga o‘tsa, boshqaruv buyruqlarini bajarishda xatolik xabarlari paydo bo‘lishi mumkin:

```bash
Error response from daemon: rpc error: code = 2 desc = The swarm does not have a leader. It's possible that too few managers are online.
```

Quorum yo‘qolganda, worker node’lardagi mavjud xizmatlar ishlashda davom etadi, ammo yangi service yoki node qo‘shish kabi boshqaruv vazifalari quorum qayta tiklanmaguncha mavjud bo‘lmaydi.

## Manager Failure’dan keyin tiklash

Agar manager nosozligi quorum yo‘qolishiga sabab bo‘lsa va barcha manager’larni qayta ishga tushirishning imkoni bo‘lmasa, siz yangi swarm cluster’ni majburan yaratishingiz mumkin. Buning uchun --force-new-cluster flag’ini va --advertise-addr parametrini birgalikda ishlating:

```bash
root@docker-master:/root # docker swarm init --advertise-addr 192.168.56.101 --force-new-cluster
```

Yangi cluster ishga tushirilgandan so‘ng, docker node ls faqat master node’ni manager sifatida ko‘rsatadi. Shundan so‘ng, worker node’larni yangi cluster’ga qayta ulashingiz mumkin. E’tibor bering, avval ro‘yxatdan o‘tgan manager node’lar bu jarayonda o‘z statusini yo‘qotadi.

## Qayta ko‘rib chiqish

Ushbu qo‘llanmada biz quyidagi asosiy jihatlarni ko‘rib chiqdik:

| Task | Tavsif | Command/Example |
|------|---------|----------------|
| **Initialize Docker Swarm** | Belgilangan master node’da to‘g‘ri advertised IP address bilan swarm’ni ishga tushirish. | `docker swarm init --advertise-addr 192.168.56.101` |
| **Add Worker Node** | Berilgan worker token yordamida yangi worker node’ni swarm’ga qo‘shish. | `docker swarm join --token <worker-token> 192.168.56.101:2377` |
| **Remove Node** | Node’ni swarm’dan toza tarzda olib tashlash va keyin master ro‘yxatidan majburan o‘chirish. | `docker swarm leave` va `docker node rm <node>` |
| **Add Manager Node** | Manager join token’ni olish va yangi manager node’da join buyrug‘ini bajarish. | `docker swarm join-token manager` |
| **Promote Worker** | Mavjud worker node’ni manager sifatida ko‘tarish orqali boshqaruv imkoniyatini kengaytirish. | `docker node promote <worker-node>` |
| **Simulate and Manage Failures** | Manager node’lar ishlamay qolganda cluster qanday harakat qilishini kuzatish va quorum muammolarini boshqarish. | Manager’ni o‘chirib, xatolikni simulyatsiya qiling va `docker node ls` buyrug‘ini bajaring. |
| **Force New Cluster Recovery** | Manager nosozligi va quorum yo‘qotilganda yangi cluster’ni majburan tiklash. | `docker swarm init --advertise-addr 192.168.56.101 --force-new-cluster` |

Docker Swarm shunday ishlab chiqilganki, manager node’lar quorum holatini saqlab turgan ekan, ba’zi node’lar ishdan chiqsa ham xizmatlar ishlashda davom etadi. Manager nosozliklari vaqtida boshqaruv funksiyalari vaqtincha bloklanishi mumkin, lekin ishlayotgan container’lar uzluksiz faoliyatini davom ettiradi.

Ushbu qo‘llanmani o‘qiganingiz uchun rahmat. Umid qilamizki, ushbu batafsil demo sizning Docker Swarm cluster’ni boshqarish bo‘yicha tushunchangizni chuqurlashtiradi va muhitda ishonchli orkestratsiyani joriy etishingizga yordam beradi.
